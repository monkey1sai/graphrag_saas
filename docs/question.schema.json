{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "rag_eval/question.schema.json",
  "title": "TWIBM GraphRAG 結構化評估 Schema（v2，向下相容）",
  "type": "array",
  "items": { "$ref": "#/$defs/QuestionItem" },
  "$defs": {
    "QuestionItem": {
      "type": "object",
      "required": ["id", "question", "expected"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "question": { "type": "string", "minLength": 1 },
        "expected": { "$ref": "#/$defs/Expected" },
        "grading": { "$ref": "#/$defs/Grading" }
      },
      "additionalProperties": true
    },
    "Expected": {
      "description": "v2 以 XLSX 欄位作為 LLM 回答範例；同時保留 v1（must_include/keywords）向下相容。",
      "oneOf": [
        { "$ref": "#/$defs/ExpectedV2" },
        { "$ref": "#/$defs/ExpectedLegacyV1" }
      ]
    },
    "ExpectedV2": {
      "type": "object",
      "required": ["answer_example", "source_map"],
      "properties": {
        "answer_example": { "$ref": "#/$defs/AnswerExampleV2" },
        "source_map": {
          "type": "array",
          "items": { "$ref": "#/$defs/SourceMapV2" }
        }
      },
      "additionalProperties": true
    },
    "AnswerExampleV2": {
      "type": "object",
      "required": [
        "target_audience",
        "main_topic",
        "sub_topic",
        "detailed_description",
        "original_evidence",
        "predicted_questions"
      ],
      "properties": {
        "target_audience": { "type": "string", "minLength": 1, "description": "目標對象" },
        "main_topic": { "type": "string", "minLength": 1, "description": "第一層關鍵詞（主旨）" },
        "sub_topic": { "type": "string", "minLength": 1, "description": "第二層關鍵詞（細項）" },
        "detailed_description": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "詳細說明（條列式）"
        },
        "original_evidence": { "type": "string", "minLength": 1, "description": "出處原文（RAG 依據）" },
        "predicted_questions": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "預測問題（QA Generation）"
        }
      },
      "additionalProperties": true
    },
    "SourceMapV2": {
      "type": "object",
      "required": ["part", "refs"],
      "properties": {
        "part": {
          "type": "string",
          "enum": ["target_audience", "main_topic", "sub_topic", "detailed_description", "original_evidence"]
        },
        "refs": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/SourceRefV2" }
        }
      },
      "additionalProperties": true
    },
    "SourceRefV2": {
      "type": "object",
      "required": ["file"],
      "properties": {
        "file": { "type": "string", "minLength": 1 },
        "sheet": { "type": "string", "minLength": 1, "description": "XLSX 工作表（若適用）" },
        "row": { "type": "integer", "minimum": 1, "description": "XLSX 列號（含表頭）" },
        "page": { "type": "integer", "minimum": 1, "description": "PDF 頁碼（若適用）" },
        "anchors": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1 },
          "description": "具體的文字錨點或 Chunk ID"
        }
      },
      "additionalProperties": true
    },
    "ExpectedLegacyV1": {
      "type": "object",
      "required": ["must_include", "keywords"],
      "properties": {
        "must_include": {
          "type": "array",
          "items": { "$ref": "#/$defs/MustIncludeGroup" }
        },
        "keywords": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": { "type": "string" }
          }
        },
        "answer_style": { "$ref": "#/$defs/AnswerStyle" },
        "sources": {
          "description": "逐 must_include item 綁定來源（file/page/anchors）",
          "type": "array",
          "items": { "$ref": "#/$defs/ItemSource" }
        }
      },
      "additionalProperties": true
    },
    "MustIncludeGroup": {
      "type": "object",
      "required": ["name", "items"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "items": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        }
      },
      "additionalProperties": true
    },
    "AnswerStyle": {
      "type": "object",
      "required": ["format", "max_length_chars"],
      "properties": {
        "format": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "max_length_chars": { "type": "integer", "minimum": 0 }
      },
      "additionalProperties": true
    },
    "ItemSource": {
      "type": "object",
      "required": ["item", "sources"],
      "properties": {
        "item": { "type": "string", "minLength": 1 },
        "sources": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/SourceRef" }
        }
      },
      "additionalProperties": true
    },
    "SourceRef": {
      "type": "object",
      "required": ["file", "page", "anchors"],
      "properties": {
        "file": { "type": "string", "minLength": 1 },
        "page": { "type": "integer", "minimum": 1 },
        "anchors": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1 }
        }
      },
      "additionalProperties": true
    },
    "Grading": {
      "type": "object",
      "required": ["coverage_weight", "grounding_weight", "conciseness_weight"],
      "properties": {
        "coverage_weight": { "type": "number", "minimum": 0, "maximum": 1 },
        "grounding_weight": { "type": "number", "minimum": 0, "maximum": 1 },
        "conciseness_weight": { "type": "number", "minimum": 0, "maximum": 1 }
      },
      "additionalProperties": true
    }
  }
}
